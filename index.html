<!DOCTYPE html>
<html lang="it" class="h-dvh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imposter Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" sizes="192x192" href="/images/icon.png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
    </style>
</head>

<body class="min-h-full flex flex-col items-center bg-gray-950 text-gray-300 p-6"
    style="font-family: 'Inter', sans-serif;">

    <!-- Login Container -->
    <div id="nickname-container" class="bg-gray-900 p-8 rounded-lg w-full max-w-md" style="display: none;">
        <h1 class="text-2xl font-medium text-white mb-6">Accedi per giocare</h1>
        <div id="g_id_onload"
             data-client_id="367803246967-1do09iukgkfag734e93krg1taj3300c6.apps.googleusercontent.com"
             data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_black" data-text="signin_with" data-shape="rectangular"></div>
    </div>

    <!-- Game Container -->
    <div id="game-container" class="bg-gray-900 p-8 rounded-lg w-full max-w-md" style="display: none;">
        <div id="game-id" class="text-sm text-gray-500 mb-2">ID Partita: </div>

        <div class="mb-6">
            <label for="id-stanza" class="text-sm text-gray-500 mb-1 block">ID Stanza:</label>
            <input type="text" id="id-stanza"
                   class="w-full h-10 px-3 bg-gray-800 text-white rounded border border-gray-700 focus:border-gray-500 focus:outline-none"
                   placeholder="Es: 1234"
                   maxlength="4"
                   pattern="[0-9]*"
                   inputmode="numeric">
        </div>

        <h2 class="text-2xl font-medium text-white mb-4">Players</h2>

        <ol id="player-list" class="list-none p-0 mb-6 space-y-2">
        </ol>

        <div id="role-images" class="hidden mb-6">
            <img class="role-image hidden w-16 mx-auto" id="good-image" src="/images/good.png">
            <img class="role-image hidden w-16 mx-auto" id="evil-image" src="/images/evil.png">
            <img class="role-image hidden w-16 mx-auto" id="fool-image" src="/images/fool.png">
        </div>

        <h3 id="word-display" class="text-lg text-gray-100 mb-6"></h3>

        <button id="start-game" class="w-full h-11 bg-gray-700 text-white rounded mb-2 hover:bg-gray-600"
            style="display: none;">
            Avvia
        </button>
        <button id="leave-game" class="w-full h-11 bg-gray-800 text-white rounded hover:bg-gray-700">
            Esci
        </button>
    </div>

    <p id="last-update" class="my-4 text-xs text-gray-600 hidden">--:--</p>

    <p id="credits" class="mt-auto text-xs text-gray-700">Made by Paul</p>
    <a class="hidden w-20 h-6 opacity-0" href="/admin"></a>

    <script>
        function handleCredentialResponse(response) {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            const fullName = payload.name;
            const email = payload.email;
            
            // Formatta come "Name S."
            const nameParts = fullName.trim().split(' ');
            let displayName;
            if (nameParts.length > 1) {
                const firstName = nameParts[0];
                const lastInitial = nameParts[nameParts.length - 1].charAt(0).toUpperCase();
                displayName = firstName + ' ' + lastInitial + '.';
            } else {
                displayName = fullName;
            }
            
            // Salva email come ID e display name per mostrare
            localStorage.setItem('user_id', email);
            localStorage.setItem('display_name', displayName);

            // Get id_stanza from localStorage if available
            var idStanza = localStorage.getItem('id_stanza') || '';

            // Entra in gioco con email come nickname (ID univoco)
            $.post('/assets/server.php', { action: 'join', nickname: email, display_name: displayName, id_stanza: idStanza }, function (resp) {
                if (resp.status === 'success') {
                    $('#nickname-container').hide();
                    $('#game-container').show();
                    $('#last-update').removeClass('hidden');
                    window.currentNickname = email;
                    window.displayName = displayName;
                    window.isLoggedIn = true;
                    window.aggiornaDati();
                }
            }, 'json');
        }

        $(document).ready(function () {
            window.currentNickname = '';
            window.displayName = '';
            window.isLoggedIn = false;

            // Check if user is already logged in
            const storedUserId = localStorage.getItem('user_id');
            const storedDisplayName = localStorage.getItem('display_name');

            // Load id_stanza from localStorage
            var storedIdStanza = localStorage.getItem('id_stanza') || '';
            $('#id-stanza').val(storedIdStanza);

            if (storedUserId) {
                window.currentNickname = storedUserId;
                window.displayName = storedDisplayName;
                $.post('/assets/server.php', { action: 'join', nickname: storedUserId, display_name: storedDisplayName, id_stanza: storedIdStanza }, function (response) {
                    if (response.status === 'success') {
                        $('#nickname-container').hide();
                        $('#game-container').show();
                        $('#last-update').removeClass('hidden');
                        window.isLoggedIn = true;
                        aggiornaDati();
                    }
                }, 'json');
            } else {
                localStorage.clear();
                $('#nickname-container').show();
                $('#last-update').removeClass('hidden');
            }

            $('#leave-game').click(function () {
                $.post('/assets/server.php', { action: 'leave', nickname: window.currentNickname }, function (response) {
                    if (response.status === 'success') {
                        localStorage.clear();
                        location.reload();
                    }
                }, 'json');
            });

            // ID Stanza input - only allow numbers
            $('#id-stanza').on('input', function () {
                var value = $(this).val().replace(/[^0-9]/g, '');
                $(this).val(value);
            });

            // Save ID Stanza on blur (focus out)
            $('#id-stanza').on('blur', function () {
                var idStanza = $(this).val();
                localStorage.setItem('id_stanza', idStanza);

                if (window.isLoggedIn && window.currentNickname) {
                    $.post('/assets/server.php', {
                        action: 'set_id_stanza',
                        nickname: window.currentNickname,
                        id_stanza: idStanza
                    }, function (response) {
                        if (response.status === 'success') {
                            window.aggiornaDati();
                        }
                    }, 'json');
                }
            });

            function aggiornaDati() {
                if (window.isLoggedIn) {
                    $.get('/assets/server.php', { action: 'get_all_data', nickname: window.currentNickname, _: new Date().getTime() }, function (response) {
                        response.giocatori.sort(function (a, b) {
                            return (a.numero || 0) - (b.numero || 0);
                        });
                        var listaGiocatori = response.giocatori.map(function (giocatore, index) {
                            var name = giocatore.display_name || giocatore.nickname;
                            return '<li class="p-3 bg-gray-800 rounded text-gray-100">' +
                                (index + 1) + '. ' + name + '</li>';
                        }).join('');
                        $('#player-list').html(listaGiocatori);

                        if (response.giocatori.length > 0) {
                            // Find first player by id_stanza_time (who set this ID first)
                            var primoGiocatore = response.giocatori.reduce(function (prev, current) {
                                var prevTime = prev.id_stanza_time || prev.login_time;
                                var currentTime = current.id_stanza_time || current.login_time;
                                return (prevTime < currentTime) ? prev : current;
                            });
                            if (primoGiocatore.nickname === window.currentNickname) {
                                $('#start-game').show();
                            } else {
                                $('#start-game').hide();
                            }
                        } else {
                            $('#start-game').hide();
                        }
                        $('#game-id').text('ID Partita: ' + response.game_id);

                        $('#word-display').html('La parola Ã¨ <span class="text-emerald-400 font-medium">' + response.word + '</span>');

                        if (response.role === 'impostore') {
                            $('#role-images').removeClass('hidden');
                            $('#good-image').addClass('hidden');
                            $('#fool-image').addClass('hidden');
                            $('#evil-image').removeClass('hidden');
                        } else if (response.role === 'buono') {
                            $('#role-images').removeClass('hidden');
                            $('#evil-image').addClass('hidden');
                            $('#fool-image').addClass('hidden');
                            $('#good-image').removeClass('hidden');
                        } else if (response.role === 'fool') {
                            $('#role-images').removeClass('hidden');
                            $('#evil-image').addClass('hidden');
                            $('#good-image').addClass('hidden');
                            $('#fool-image').removeClass('hidden');
                        } else {
                            $('#role-images').addClass('hidden');
                            $('.role-image').addClass('hidden');
                        }

                        var userStillInGame = response.giocatori.some(function (giocatore) {
                            return giocatore.nickname === window.currentNickname;
                        });

                        if (!userStillInGame) {
                            localStorage.removeItem('user_id');
                            localStorage.removeItem('display_name');
                            localStorage.removeItem('login_time');
                            window.location.reload();
                        }

                        var currentTime = new Date();
                        var formattedTime = currentTime.toLocaleTimeString('it-IT', { hour12: false });
                        $('#last-update').text(formattedTime);
                    }, 'json');
                }
            }
            window.aggiornaDati = aggiornaDati;

            $('#start-game').click(function () {
                $.post('/assets/server.php', { action: 'start_game', nickname: window.currentNickname }, function (response) {
                    if (response.status === 'success') {
                        $('#game-id').text('ID Partita: ' + response.game_id);
                        aggiornaDati();
                    } else if (response.message) {
                        alert(response.message);
                    }
                }, 'json');
            });

            setInterval(aggiornaDati, 1000);
        });
    </script>

</body>


</html>
